name: skyparser
on: [push]
jobs:
  build_images:
    runs-on: ubuntu-latest
    steps:
      - name: clone repo
        uses: actions/checkout@v3
      - name: copy files
        run: |
          cp constants.py telegram_bot/
          cp create_loggers.py telegram_bot/
          cp managers/logging_manager.py telegram_bot/managers/
      - name: build telebot image
        run: docker build -t plamer88/sky_parser:telebot-$GITHUB_RUN_ID telegram_bot/.
      - name: docker login
        run: echo ${{secrets.DOCKER_TOKEN}} | docker login -u plamer88 --password-stdin
      - name: push telebot image
        run: docker push plamer88/sky_parser:telebot-$GITHUB_RUN_ID

  deploy_application:
    runs-on: ubuntu-latest
    needs: build_images
    env:
      BOT_TOKEN: ${{secrets.BOT_TOKEN}}
      GOOGLE_SHEET_PRIVATE_KEY: ${{secrets.GOOGLE_SHEET_PRIVATE_KEY}}
      SERVER_PASSWORD: ${{secrets.PASSWORD}}
    steps:
      - name: clone repo
        uses: actions/checkout@v3
      - name: prepare files
        run: |
          cat telegram_bot/.env-ci | envsubst > .env
          cat auth_data/skyparser-ci.json | envsubst > auth_data/skyparser-b7b18db49e8d.json
          cat docker-compose-ci.yaml | envsubst > docker-compose.yaml
      - name: copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{secrets.HOST}}
          username: ${{secrets.USERNAME}}
          password: ${{secrets.PASSWORD}}
          source: '*,!telegram_bot'
          target: '/home/sky_parser'
      - name: run application
        uses: appleboy/ssh-action@master
        with:
          host: ${{secrets.HOST}}
          username: ${{secrets.USERNAME}}
          password: ${{secrets.PASSWORD}}
          script: |
            cd /home/sky_parser
            echo ${{secrets.PASSWORD}} | sudo -S docker-compose up -d --build
            echo ${{secrets.PASSWORD}} | sudo -S docker system prune -a -f
            echo ${{secrets.PASSWORD}} | sudo -S cp sky_parser.service /etc/systemd/system/
            echo ${{secrets.PASSWORD}} | sudo -S systemctl stop sky_parser
            echo ${{secrets.PASSWORD}} | sudo -S systemctl daemon-reload
            echo ${{secrets.PASSWORD}} | sudo -S systemctl start sky_parser
            echo ${{secrets.PASSWORD}} | sudo -S systemctl enable sky_parser
            
